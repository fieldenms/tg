<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <title>compound master tests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    <script src="/resources/polymer/@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
    <script src='/resources/polymer/web-animations-js/web-animations-next-lite.min.js'></script>
    <script src="/resources/filesaver/FileSaver.min.js"></script>
    <script src="/resources/polymer/wct-browser-legacy/browser.js"></script>
</head>

<body>
    <test-fixture id="CentreFixture">
        <template>
            <tg-MiTgCompoundEntity-centre id="centre"></tg-MiTgCompoundEntity-centre>
        </template>
    </test-fixture>

    <script type="module">
        import '/centre_ui/fielden.test_app.main.menu.compound.MiTgCompoundEntity';

        suite('persisted case', function () {
            let centre;

            setup(function () {
                centre = fixture('CentreFixture');

                const old_showDialog = centre._showDialog;
                centre._showDialog = (function (action) {
                    old_showDialog(action);
                    centre.async(() => {
                        if (centre.actionDialog !== null) {
                            centre.actionDialog._entityReceived = entity => {}; // avoid tearDownEvent() for 'tg-entity-received' to propagate it to <body> (see tg-custom-action-dialog._entityReceived)
                        }
                    }, 1);
                });
            });

            const assertPersistedWithKey = (entity, expectedKey) => {
                assert.isOk(entity);
                assert.isNumber(entity.get('id'));
                assert.strictEqual(entity.get('key'), expectedKey);
            };

            const assertPersistedWithDesc = (entity, expectedDesc) => {
                assert.isOk(entity);
                assert.isNumber(entity.get('id'));
                assert.strictEqual(entity.get('desc'), expectedDesc);
            };

            const assertPersistedWithDate = (entity) => {
                assert.isOk(entity);
                assert.isNumber(entity.get('id'));
                assert.isNumber(entity.get('date'));
            };

            const dialog = () => document.body
                .querySelector('tg-custom-action-dialog');

            const entityMaster = () => document.body
                .querySelector('tg-custom-action-dialog').shadowRoot
                .querySelector('tg-OpenTgCompoundEntityMasterAction-master').shadowRoot
                .querySelector('tg-master-menu-item-section[data-route="TgCompoundEntityMaster_OpenMain_MenuItem"]').shadowRoot
                .querySelector('tg-tgcompoundentitymaster_openmain_menuitem-master').shadowRoot
                .querySelector('tg-tgcompoundentity-master');

            const detailMaster = () => document.body
                .querySelector('tg-custom-action-dialog').shadowRoot
                .querySelector('tg-OpenTgCompoundEntityMasterAction-master').shadowRoot
                .querySelector('tg-master-menu-item-section[data-route="TgCompoundEntityMaster_OpenTgCompoundEntityDetail_MenuItem"]').shadowRoot
                .querySelector('tg-tgcompoundentitymaster_openTgCompoundEntityDetail_menuitem-master').shadowRoot
                .querySelector('tg-tgcompoundentitydetail-master');

            const masterMenu = () => document.body
                .querySelector('tg-custom-action-dialog').shadowRoot
                .querySelector('tg-OpenTgCompoundEntityMasterAction-master').shadowRoot
                .querySelector('tg-master-menu');

            const changeEntityPropAndSave = (prop, val) => {
                setTimeout(() => {
                    const master = entityMaster();
                    const edProperty = master.$[`editor_4_${prop}`];
                    edProperty._editingValue = val;
                    edProperty.commit();
                    const saveButton = master.shadowRoot.querySelector('tg-action[role="save"]');
                    saveButton._asyncRun();
                });
            };

            const changeDetailPropAndSave = (prop, val) => {
                setTimeout(() => {
                    const master = detailMaster();
                    const edProperty = master.$[`editor_4_${prop}`];
                    edProperty._editingValue = val;
                    edProperty.commit();
                    const saveButton = master.shadowRoot.querySelector('tg-action[role="save"]');
                    saveButton._asyncRun();
                });
            };

            test('tapping edit action opens compound master with main menu item and fetches entity and updates dialog title', function (done) {
                // 1. retrieve 2. save OpenTgCompoundEntityMasterAction
                // 1. retrieve 2. save TgCompoundEntityMaster_OpenMain_MenuItem
                // 1. retrieve         TgCompoundEntity
                centre.retrieve().then(() => centre.run()).then(() => {
                    const listener = event => {
                        const entity = event.detail;
                        if (entity.type()._simpleClassName() === 'OpenTgCompoundEntityMasterAction') { // both retrieval and save here
                            assertPersistedWithKey(entity.get('key'), '1TEST');
                            assert.strictEqual(entity.get('sectionTitle'), '1TEST: 1TEST (1TEST detail)');
                            assert.strictEqual(entity.get('menuToOpen'), null);
                        } else if (entity.type()._simpleClassName() === 'TgCompoundEntityMaster_OpenMain_MenuItem') { // both retrieval and save here
                            assertPersistedWithKey(entity.get('key'), '1TEST');
                        } else if (entity.type()._simpleClassName() === 'TgCompoundEntity') { // retrieval only
                            assertPersistedWithKey(entity, '1TEST');
                            dialog().closeDialog(true);
                            document.body.removeEventListener('tg-entity-received', listener);
                            done();
                        }
                    };
                    document.body.addEventListener('tg-entity-received', listener);
                    const editAction = centre.$.egi.$.primary_action_selector.assignedNodes()[0].actions[0];
                    editAction.currentEntity = () => centre.$.egi.entities[0];
                    editAction._run();
                });
            });

            test('changing entity and saving it leads to dialog title update', function (done) {
                let openerCount = 0, entityCount = 0;
                // PREPARE
                // 1. retrieve 2. save OpenTgCompoundEntityMasterAction
                // 1. retrieve 2. save TgCompoundEntityMaster_OpenMain_MenuItem
                // 1. retrieve         TgCompoundEntity

                // CHANGE => ASSERT 1 => ASSERT 2
                // 2. validate 3. save TgCompoundEntity
                // 3. save             OpenTgCompoundEntityMasterAction

                // change state back
                // 4. validate 5. save TgCompoundEntity
                // 4. save             OpenTgCompoundEntityMasterAction
                centre.retrieve().then(() => centre.run()).then(() => {
                    const listener = event => {
                        const entity = event.detail;
                        if (entity.type()._simpleClassName() === 'TgCompoundEntity') {
                            entityCount++;
                            if (entityCount === 1) {
                                changeEntityPropAndSave('key', '1TEST_CHANGED'); // CHANGE =>
                            } else if (entityCount === 3) {
                                assertPersistedWithKey(entity, '1TEST_CHANGED'); // => ASSERT 1 =>
                                changeEntityPropAndSave('key', '1TEST'); // change state back
                            }
                        } else if (entity.type()._simpleClassName() === 'OpenTgCompoundEntityMasterAction') {
                            openerCount++;
                            if (openerCount === 3) {
                                assertPersistedWithKey(entity.get('key'), '1TEST_CHANGED'); // => ASSERT 2
                                assert.strictEqual(entity.get('sectionTitle'), '1TEST_CHANGED: 1TEST (1TEST detail)');
                                assert.strictEqual(entity.get('menuToOpen'), null);
                            } else if (openerCount === 4) {
                                assert.strictEqual(entityCount, 5);
                                document.body.removeEventListener('tg-entity-received', listener);
                                dialog().closeDialog(true);
                                done();
                            }
                        }
                    };
                    document.body.addEventListener('tg-entity-received', listener);
                    const editAction = centre.$.egi.$.primary_action_selector.assignedNodes()[0].actions[0];
                    editAction.currentEntity = () => centre.$.egi.entities[0];
                    editAction._run();
                });
            });

            test('moving to detail menu item fetches detail entity and moving back to main menu item fetches entity', function (done) {
                let entityCount = 0;
                // PREPARE
                // 1. retrieve 2. save OpenTgCompoundEntityMasterAction
                // 1. retrieve 2. save TgCompoundEntityMaster_OpenMain_MenuItem
                // 1. retrieve         TgCompoundEntity

                // CHANGE 1 => ASSERT 1 => ASSERT 2
                // 1. retrieve 2. save TgCompoundEntityMaster_OpenTgCompoundEntityDetail_MenuItem
                // 1. retrieve         TgCompoundEntityDetail

                // CHANGE 2 => ASSERT 3 => ASSERT 4
                // 3. retrieve 4. save TgCompoundEntityMaster_OpenMain_MenuItem
                // 2. retrieve         TgCompoundEntity
                centre.retrieve().then(() => centre.run()).then(() => {
                    const listener = event => {
                        const entity = event.detail;
                        if (entity.type()._simpleClassName() === 'TgCompoundEntity') {
                            entityCount++;
                            if (entityCount === 1) {
                                masterMenu().route = 'TgCompoundEntityMaster_OpenTgCompoundEntityDetail_MenuItem'; // CHANGE 1 =>
                            } else if (entityCount === 2) {
                                document.body.removeEventListener('tg-entity-received', listener);
                                dialog().closeDialog(true);
                                done();
                            }
                        } else if (entity.type()._simpleClassName() === 'TgCompoundEntityMaster_OpenTgCompoundEntityDetail_MenuItem') { // both retrieval and save here
                            assertPersistedWithKey(entity.get('key'), '1TEST'); // => ASSERT 1 / 3 =>
                        } else if (entity.type()._simpleClassName() === 'TgCompoundEntityDetail') {
                            assertPersistedWithDesc(entity, '1TEST detail'); // => ASSERT 2
                            masterMenu().route = 'TgCompoundEntityMaster_OpenMain_MenuItem'; // CHANGE 2 =>
                        } 
                    };
                    document.body.addEventListener('tg-entity-received', listener);
                    const editAction = centre.$.egi.$.primary_action_selector.assignedNodes()[0].actions[0];
                    editAction.currentEntity = () => centre.$.egi.entities[0];
                    editAction._run();
                });
            });

            test('changing of detail entity and saving it leads to dialog title update', function (done) {
                let openerCount = 0, detailCount = 0;
                // PREPARE
                // 1. retrieve 2. save OpenTgCompoundEntityMasterAction
                // 1. retrieve 2. save TgCompoundEntityMaster_OpenMain_MenuItem
                // 1. retrieve         TgCompoundEntity
                // 1. retrieve 2. save TgCompoundEntityMaster_OpenTgCompoundEntityDetail_MenuItem
                // 1. retrieve         TgCompoundEntityDetail


                // CHANGE => ASSERT 1 => ASSERT 2
                // 2. validate 3. save TgCompoundEntityDetail
                // 3. save             OpenTgCompoundEntityMasterAction

                // change state back
                // 4. validate 5. save TgCompoundEntityDetail
                // 4. save             OpenTgCompoundEntityMasterAction
                centre.retrieve().then(() => centre.run()).then(() => {
                    const listener = event => {
                        const entity = event.detail;
                        console.warn('TG-ENTITY_RECEIVED: ', entity.type()._simpleClassName());
                        if (entity.type()._simpleClassName() === 'TgCompoundEntity') {
                            masterMenu().route = 'TgCompoundEntityMaster_OpenTgCompoundEntityDetail_MenuItem';
                        } else if (entity.type()._simpleClassName() === 'TgCompoundEntityDetail') {
                            detailCount++;
                            if (detailCount === 1) {
                                changeDetailPropAndSave('desc', '1TEST detail_CHANGED'); // CHANGE =>
                            } else if (detailCount === 3) {
                                assertPersistedWithDesc(entity, '1TEST detail_CHANGED'); // => ASSERT 1 =>
                                changeDetailPropAndSave('desc', '1TEST detail'); // change state back
                            }
                        } else if (entity.type()._simpleClassName() === 'OpenTgCompoundEntityMasterAction') {
                            openerCount++;
                            if (openerCount === 3) {
                                assertPersistedWithKey(entity.get('key'), '1TEST'); // => ASSERT 2
                                assert.strictEqual(entity.get('sectionTitle'), '1TEST: 1TEST (1TEST detail_CHANGED)');
                                assert.strictEqual(entity.get('menuToOpen'), null);
                            } else if (openerCount === 4) {
                                assert.strictEqual(detailCount, 5);
                                document.body.removeEventListener('tg-entity-received', listener);
                                dialog().closeDialog(true);
                                done();
                            }
                        }
                    };
                    document.body.addEventListener('tg-entity-received', listener);
                    const editAction = centre.$.egi.$.primary_action_selector.assignedNodes()[0].actions[0];
                    editAction.currentEntity = () => centre.$.egi.entities[0];
                    editAction._run();
                });
            });

            test('moving to children menu item fetches children entities and moving back to main menu item fetches entity', function (done) {
                let entityCount = 0;
                // PREPARE
                // 1. retrieve 2. save OpenTgCompoundEntityMasterAction
                // 1. retrieve 2. save TgCompoundEntityMaster_OpenMain_MenuItem
                // 1. retrieve         TgCompoundEntity

                // CHANGE 1 => ASSERT 1 => ASSERT 2
                // 1. retrieve 2. save TgCompoundEntityMaster_OpenTgCompoundEntityChild_MenuItem
                // 1. run              TgCompoundEntityChild

                // CHANGE 2 => ASSERT 3 => ASSERT 4
                // 3. retrieve 4. save TgCompoundEntityMaster_OpenMain_MenuItem
                // 2. retrieve         TgCompoundEntity
                centre.retrieve().then(() => centre.run()).then(() => {
                    const listenerEmbCentre = event => {
                        const entity = event.detail.entities[0];
                        if (entity && entity.type()._notEnhancedSimpleClassName() === 'TgCompoundEntityChild') {
                            assertPersistedWithDate(entity); // => ASSERT 2
                            setTimeout(() => {
                                masterMenu().route = 'TgCompoundEntityMaster_OpenMain_MenuItem'; // CHANGE 2 =>
                            });
                        }
                    };
                    const listener = event => {
                        const entity = event.detail;
                        if (entity.type()._simpleClassName() === 'TgCompoundEntity') {
                            entityCount++;
                            if (entityCount === 1) {
                                masterMenu().route = 'TgCompoundEntityMaster_OpenTgCompoundEntityChild_MenuItem'; // CHANGE 1 =>
                            } else if (entityCount === 2) {
                                document.body.removeEventListener('tg-entity-received', listener);
                                document.body.removeEventListener('tg-entity-centre-refreshed', listenerEmbCentre);
                                dialog().closeDialog(true);
                                done();
                            }
                        } else if (entity.type()._simpleClassName() === 'TgCompoundEntityMaster_OpenTgCompoundEntityChild_MenuItem') { // both retrieval and save here
                            assertPersistedWithKey(entity.get('key'), '1TEST'); // => ASSERT 1 =>
                        }
                    };
                    document.body.addEventListener('tg-entity-received', listener);
                    document.body.addEventListener('tg-entity-centre-refreshed', listenerEmbCentre);
                    const editAction = centre.$.egi.$.primary_action_selector.assignedNodes()[0].actions[0];
                    editAction.currentEntity = () => centre.$.egi.entities[0];
                    editAction._run();
                });
            });

        });

    </script>
</body>
</html>