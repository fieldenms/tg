<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/iron-icons/iron-icons.html">
<link rel="import" href="/resources/polymer/paper-menu/paper-menu.html">
<link rel="import" href="/resources/polymer/paper-styles/color.html">
<link rel="import" href="/resources/polymer/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/resources/polymer/paper-item/paper-item.html">
<link rel="import" href="/resources/polymer/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/resources/polymer/paper-fab/paper-fab.html">
<link rel="import" href="/resources/components/postal-lib.html">
<link rel="import" href="/resources/views/tg-menu-item-view.html">
<link rel="import" href="/app/tg-app-config.html">
<link rel="import" href="/resources/polymer/neon-animation/neon-animated-pages.html">
<link rel="import" href="/resources/polymer/neon-animation/neon-animation.html">


<dom-module id="tg-view-with-menu">
    <style>
        :host {
            --paper-fab-background: #fcfcfc;
            --paper-menu-color: #01579b;
            --paper-item-min-height: 40px;
            --paper-fab: {
                color: #666464;
                position: absolute;
                top: 16px;
                right:16px;
                z-index: 1;
                width: 50px;
                height: 50px;
            }
            ;
            --paper-menu: {
                padding: 0;
                margin: 0;
            }
            ;
            --paper-item: {
                padding-left: 22px;
                font-size: 13px;
                cursor: pointer;
                transition: all 300ms ease-in-out;
            }
            ;
        }
        neon-animated-pages {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            top: 44px;
        }
        .menu-item-view {
            overflow: auto;
        }
        .tool-bar {
            padding: 0 16px;
            height: 44px;
            font-size: 18px;
            color: white;
            background-color: var(--paper-light-blue-700);
        }
        
        #drawerPanel:not([narrow]) #menuButton {
            display: none;
        }
        #drawerPanel:not([narrow]) paper-menu {
            border-right: 1px solid #CBCDCE;
        }
        #menuButton {
            margin-right: 24px;
        }
    </style>
    <template>
        <tg-app-config id="app_config"></tg-app-config>
        <paper-drawer-panel id="drawerPanel" disable-swipe force-narrow>

            <div class="layout vertical" drawer>

                <div id="menuToolBar" class="tool-bar layout horizontal center">
                    <div class="flex">[[menuItem.title]]</div>
                </div>

                <paper-menu id="menu" class="flex" on-selected-changed="_menuItemSelected" attr-for-selected="name">
                    <template is="dom-repeat" items="[[menuItem.menu]]">
                        <paper-item name$="[[item.title]]">[[item.title]]</paper-item>
                    </template>
                </paper-menu>

            </div>

            <div class="layout vertical" main>

                <div id="viewToolBar" class="tool-bar layout horizontal center">
                    <div class="layout horizontal center flex">
                        <paper-icon-button id="menuButton" icon="menu" on-tap="_togglePanel"></paper-icon-button>
                        <div class="flex">[[_calcSelectedPageTitle(pageSelected)]]</div>
                    </div>
                    <paper-fab id="fab" icon="apps" on-tap="_showMenu"></paper-fab>
                </div>

                <neon-animated-pages id="pages" selected=[[pageSelected]] attr-for-selected="name" entry-animation="fade-in-animation" exit-animation="fade-out-animation" on-selected-changed="_pageSelectedChanged" on-neon-animation-finish="_animationFinished">
                    <div class="menu-item-view" name="__empty__"></div>
                    <template is="dom-repeat" items="[[menuItem.menu]]">
                        <div class="menu-item-view" name$="[[item.title]]">
                            <tg-menu-item-view menu-item="[[item]]" uuid="[[_calcUuid(item)]]" module-id="[[menuItem.title]]"></tg-menu-item-view>
                        </div>
                    </template>
                </neon-animated-pages>

            </div>


        </paper-drawer-panel>
    </template>
</dom-module>
<script>
    (function () {
        Polymer({

            is: "tg-view-with-menu",

            properties: {
                menuItem: Object,
                animationConfig: {
                    value: function () {
                        return {
                            'entry': [
                                {
                                    name: 'slide-down-animation',
                                    node: this.$.menuToolBar
                                }, {
                                    name: 'slide-down-animation',
                                    node: this.$.viewToolBar
                                }, {
                                    name: 'transform-animation',
                                    node: this.$.menu,
                                    transformFrom: "translateY(100%)",
                                    tranformTo: "none"
                                }, {
                                    name: 'transform-animation',
                                    node: this.$.pages,
                                    transformFrom: "translateY(100%)",
                                    tranformTo: "none"
                                }, {
                                    name: 'scale-up-animation',
                                    node: this.$.fab,
                                    timing: {
                                        delay: 400
                                    }
                                }
                            ],
                            'exit': [
                                {
                                    name: 'slide-up-animation',
                                    node: this.$.menuToolBar
                                }, {
                                    name: 'slide-up-animation',
                                    node: this.$.viewToolBar
                                }, {
                                    name: 'transform-animation',
                                    node: this.$.menu,
                                    transformFrom: "none",
                                    transformTo: "translateY(100%)"
                                }, {
                                    name: 'transform-animation',
                                    node: this.$.pages,
                                    transformFrom: "none",
                                    transformTo: "translateY(100%)"
                                }, {
                                    name: 'scale-down-animation',
                                    node: this.$.fab
                                }
                            ]
                        };
                    }
                }
            },

            behaviors: [
                Polymer.NeonAnimatableBehavior
            ],

            hostAttributes: {
                class: "layout vertical"
            },

            ready: function () {
                var self = this,
                    masterCounter = 1;
                self.startUp = true;
                self.$.menu.selected = "__empty__";
                ////////////////// State related events ///////////////////////////
                postal.subscribe({
                    channel: self.menuItem.title,
                    topic: "state.push",
                    callback: function (data, envelope) {
                        var newState = data.state;
                        if (self.$.menu.selected) {
                            newState.push(self.$.menu.selected);
                        }
                        self._initDrawerPanel();
                        history.pushState(newState, "");
                        postal.publish({
                            channel: "app",
                            topic: "state.pushed",
                            data: {
                                state: newState
                            }
                        });
                    }
                });
                postal.subscribe({
                    channel: self.menuItem.title,
                    topic: "state.pop",
                    callback: function (data, envelope) {
                        if (data.state[1] === self.$.menu.selected) {
                            postal.publish({
                                channel: "app",
                                topic: "state.poped",
                                data: data
                            });
                        } else {
                            self.restoringState = true;
                            self.$.menu.selected = data.state[1];
                        }
                        self._initDrawerPanel();
                    }
                });
                postal.subscribe({
                    channel: self.menuItem.title,
                    topic: "state.select",
                    callback: function (data, envelop) {
                        if (data.state[1] === self.$.menu.selected) {
                            history.pushState(data.state, "");
                        } else {
                            self.$.menu.selected = data.state[1];
                        }
                        self._initDrawerPanel();
                        postal.publish({
                            channel: "app",
                            topic: "state.pushed",
                            data: data
                        });
                    }
                });
                //////////////////////////Edit actions//////////////////////////////////
                postal.subscribe({
                    channel: "manager_" + self.menuItem.title,
                    topic: "master.edit.create",
                    callback: function (data, envelope) {
                        var idArray = data.view.attrs.uuid.split('/');
                        self.push("menuItem.menu", data);
                        self.async(function () {
                            self.$.menu.selected = idArray[1];
                        }, 1);
                    }
                });

                postal.subscribe({
                    channel: "manager_" + self.menuItem.title,
                    topic: "master.show",
                    callback: function (data, envelope) {
                        var idArray = data.item.view.attrs.uuid.split('/');
                        if (idArray[0] !== self.menuItem.title) {
                            postal.publish({
                                channel: idArray[0],
                                topic: "state.select",
                                data: {
                                    state: idArray
                                }
                            })
                        } else {
                            self.$.menu.selected = idArray[1];
                        }
                        postal.publish({
                            channel: "view",
                            topic: "master.shown",
                            data: data
                        });
                    }
                });
                /////////////////New Actions//////////////////////////////
                postal.subscribe({
                    channel: "manager_" + self.menuItem.title,
                    topic: "master.new.create",
                    callback: function (data, envelope) {
                        var centreUuid = data.view.attrs.centreUuid.split('/');
                        centreUuid[centreUuid.length - 1] = "New Master #" + masterCounter;
                        data.title = "New Master #" + masterCounter;
                        data.description = "New Master #" + masterCounter;
                        data.view.attrs.uuid = centreUuid.join('/');
                        masterCounter += 1;
                        self.push("menuItem.menu", data);
                        self.async(function () {
                            self.$.menu.selected = centreUuid[1];
                        }, 1);
                    }
                });
                //////////////Master save acation////////////////////////////
                postal.subscribe({
                    channel: "manager_" + self.menuItem.title,
                    topic: "master.saved",
                    callback: function (data, envelope) {
                        var centreUuid = data.centreUuid.split('/');
                        postal.publish({
                            channel: "view",
                            topic: "master.saved",
                            data: data
                        });
                        self.$.menu.selected = centreUuid[1];
                    }
                });
            },

            _initDrawerPanel: function () {
                if (this.$.menu.selected === '__empty__') {
                    this.$.drawerPanel.selected = 'drawer';
                } else {
                    this.$.drawerPanel.selected = 'main';
                }
            },

            _showMenu: function (e, detail, source) {
                this.fire("main-menu");
            },

            _menuItemSelected: function (e, detail, source) {
                this.pageSelected = detail.value;
            },

            _calcSelectedView: function (selectedPage) {
                if (selectedPage == '__empty__') {
                    return 'drawer';
                } else {
                    return 'main';
                }
            },

            _togglePanel: function (e, detail, source) {
                this.$.drawerPanel.togglePanel();
            },

            _calcSelectedPageTitle: function (page) {
                return page === '__empty__' ? '' : page;
            },

            _calcUuid: function (item) {
                return this.menuItem.title + '/' + item.title;
            },

            _pageSelectedChanged: function (e, detail, source) {
                var state;
                if (e.target === this.$.pages) {
                    state = [this.menuItem.title, this.$.menu.selected];
                    if (this.startUp) {
                        this.startUp = false;
                    } else if (this.restoringState) {
                        this.restoringState = false;
                        postal.publish({
                            channel: "app",
                            topic: "state.poped",
                            data: {
                                state: state
                            }
                        });
                    } else {
                        history.pushState(state, "");
                        this._initDrawerPanel();
                        //this.$.drawerPanel.closeDrawer();
                    }
                }
            },

            _animationFinished: function (e, detail, source) {
                var viewToLoad;
                if (this.$.menu.selected != '__empty__') {
                    viewToLoad = Polymer.dom(detail.toPage).querySelector('tg-menu-item-view');
                    if (viewToLoad && !viewToLoad.wasLoaded()) {
                        viewToLoad.load();
                    }
                }
            }
        });
    })();
</script>