<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/neon-animation/neon-animated-pages.html">
<link rel="import" href="/resources/polymer/carbon-route/carbon-location.html">
<link rel="import" href="/resources/polymer/carbon-route/carbon-route.html">
<link rel="import" href="/resources/views/tg-app-menu.html">
<link rel="import" href="/resources/views/tg-app-view.html">
<link rel="import" href="/resources/components/postal-lib.html">
<link rel="import" href="/resources/app/tg-view-manager.html">

<dom-module id="tg-desktop-app">
    <style>
        :host {
            overflow: hidden;
        }
    </style>
    <template>
        <tg-view-manager></tg-view-manager>
        <carbon-location id="location" route="{{_route}}" url-space-regex="^/#/" use-hash-as-path></carbon-location>
        <carbon-route route="{{_route}}" pattern="/:moduleName" data="{{_routeData}}" tail="{{_subroute}}"></carbon-route>
        <neon-animated-pages id="pages" class="fit" attr-for-selected="name" animate-initial-selection>
            <tg-app-menu class="fit" name="menu" menu-config="[[menuConfig]]"></tg-app-menu>
            <template is="dom-repeat" items="[[menuConfig.items]]" on-dom-change="_modulesRendered">
                <tg-app-view class="fit hero-animatable" name$="[[item.title]]" menu-item="[[item]]" selected-module="[[_routeData.moduleName]]" submodule="{{_subroute}}"></tg-app-view>
            </template>
        </neon-animated-pages>
    </template>
</dom-module>

<script>
    (function () {
        var findModule = function (moduleName, menuConfig) {
            var itemIndex;
            for (itemIndex = 0; itemIndex < menuConfig.items.length; itemIndex++) {
                if (menuConfig.items[itemIndex].title === moduleName) {
                    return moduleName;
                }
            }
            return "menu";
        };
        Polymer({

            is: "tg-desktop-app",

            properties: {
                _route: {
                    type: Object,
                    observer: "_routeChanged"
                },
                _routeData: Object,
                _subroute: Object
            },

            listeners: {
                "main-menu": "_showMainMenu",
                "menu-item-selected": "_showView"
            },

            _routeChanged: function (newValue, oldValue) {
                this._routeData && this._setSelected(decodeURIComponent(this._routeData.moduleName));
            },

            _showMainMenu: function (e) {
                this._setSelected("menu");
            },

            _showView: function (e) {
                var route = "/" + encodeURIComponent(e.detail),
                    elementToSelect = this.$$("[name='" + e.detail + "']"),
                    selectedSubPage = elementToSelect.getSelectedPage();
                if (selectedSubPage) {
                    route += "/" + encodeURIComponent(selectedSubPage);
                }
                if (this._route.path === route) {
                    this._setSelected(e.detail);
                } else {
                    this.set("_route.path", route);
                }
            },

            _modulesRendered: function (e) {
                if (this.selectAfterRender) {
                    this.async(function () {
                        this._setSelected(this.selectAfterRender);
                        delete this.selectAfterRender;
                    });
                }
            },

            _setSelected: function (selected) {
                var currentlySelected, currentlySelectedElement, elementToSelect;
                if (this.menuConfig) {
                    currentlySelected = this.$.pages.selected;
                    currentlySelectedElement = currentlySelected && this.$$("[name='" + currentlySelected + "']");
                    selected = findModule(selected, this.menuConfig)
                    elementToSelect = selected && this.$$("[name='" + selected + "']");
                    if (currentlySelectedElement) {
                        currentlySelectedElement.configureExitAnimation(selected);
                    }
                    if (elementToSelect) {
                        elementToSelect.configureEntryAnimation(currentlySelected);
                        this.$.pages.selected = selected;
                        return;
                    }
                }
                this.selectAfterRender = selected;
            },

            _checkWeatherCanLeave: function (e) {
                var modules = this.querySelectorAll("tg-app-view");
                var customDialogs = document.body.querySelectorAll("tg-custom-action-dialog");
                var changedEntityCentres = [];
                var master, itemIndex, viewToCheck;
                for (itemIndex = 0; itemIndex < modules.length; itemIndex++) {
                    viewToCheck = typeof modules[itemIndex].canLeave === 'function' && modules[itemIndex].canLeave();
                    if (Array.isArray(viewToCheck)) {
                        viewToCheck.forEach(function(element) {
                            changedEntityCentres.push(element);    
                        });
                    } else if (viewToCheck) {
                        changedEntityCentres.push(viewToCheck);
                    }
                }
                if (changedEntityCentres.length > 0) {
                    e.returnValue = "The following menu items were changed:\n";
                    changedEntityCentres.forEach(function(element) {
                        e.returnValue += "\t * " + element + "\n";
                    });
                }
                for (itemIndex = 0; itemIndex < customDialogs.length; itemIndex++) {
                    if (customDialogs[itemIndex].style.display !== 'none') {
                        master = customDialogs[itemIndex].querySelector(".canLeave");
                        if (master && typeof master.canLeave === 'function' && master.canLeave()) {
                            e.returnValue = "There are some unsaved entity masters.";
                        }
                    }
                }
            },

            ready: function () {
                //Setting dwellTime to 0 for iron-location that is in the shadow-dom of carbon-location component. This fixes the problem of delayong the history changes.
                this.$.location.$$("iron-location").dwellTime = 0;
                //Binding to 'this' functions those are used outside the scope of this component.
                this._checkWeatherCanLeave = this._checkWeatherCanLeave.bind(this);
            },

            attached: function () {
                var self = this;
                this.menuConfig = @menuConfig;

                this.async(function () {
                    if (!this._route.path) {
                        this.set("_route.path", "/menu");
                    }
                });

                window.addEventListener("beforeunload", this._checkWeatherCanLeave);
            },

            detached: function () {
                window.removeEventListener("beforeunload", this._checkWeatherCanLeave);
            }
        });
    })();
</script>