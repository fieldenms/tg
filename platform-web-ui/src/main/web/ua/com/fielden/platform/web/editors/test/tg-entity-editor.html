<!doctype html>
<html>

<head>
	<meta charset="UTF-8">
	<title>entity-master basic tests</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	
	<script src="/resources/polymer/@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
    <script src='/resources/polymer/web-animations-js/web-animations-next-lite.min.js'></script>
    <script src="/resources/filesaver/FileSaver.min.js"></script>
    <script src="/resources/polymer/wct-browser-legacy/browser.js"></script>
</head>

<body>
	<tg-reflector id="reflector"></tg-reflector>
	<test-fixture id="MasterFixture">
    	<template>
   		    <tg-TgPersistentEntityWithProperties-master 
		    	id="master" 
		    	entity-type="ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties" 
		    	entity-id="new" 
		    	current-state="EDIT">
    		</tg-TgPersistentEntityWithProperties-master>
    	</template>
	</test-fixture>

	<script type="module">

		import '/app/tg-reflector.js';
		import '/master_ui/ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties';

		suite('entity editor layer formatted composite entity', function() {
		    let master, reflector;
		
		    setup(function() {
				master = fixture('MasterFixture');
		      	reflector = document.querySelector('#reflector');
		    });
		
		    test('works for "z" format', function (done) {
		    	master.entityId = '16';
				const compPropEditor = master.$.editor_4_compositeProp;

				const resolveFunc = function(editorText, bindingEntity) {
					
				};

				master.postRetrieved = function(entity, bindingEntity, customObject) {
					const compProp = reflector.getEntityTypeProp(reflector.tg_getFullEntity(bindingEntity), "compositeProp");
					compProp._displayAs="z";
					master.retrieve();
					master.postRetrieved = function (entity, bindingEntity, customObject) {
						setTimeout(() => {
							compPropEditor._copyTap();
							compPropEditor.$.input.focus();
							navigator.clipboard.readText().then(editorText => {
								assert.strictEqual(reflector.getEntityTypeProp(reflector.tg_getFullEntity(bindingEntity), "compositeProp")._displayAs, "z", "The template should be 'z'");
								assert.strictEqual(editorText, "DEFAULT_KEY 10\u00a0\u2013\u00a0Default composite entity description as a long text to demonstrate proper word wrapping as part of displaying the autocompleted values.", "The copied value is incorrect");
								done();
							});
						}, 1);
					};
				}

	            master.retrieve();
            });
		});
    </script>
</body>

</html>