<link rel="import" href="/resources/components/postal-lib.html">
<link rel="import" href="/resources/binding/tg-entity-binder-behavior.html">

<script>
    (function () {
        var SimultaneousSaveException = function () {
            Object.call(this);

            this.message = "Simultaneous save exception: the save process has been already started before and not ended. Please, block UI until the save action completes.";
        };
        SimultaneousSaveException.prototype = Object.create(Object.prototype);
        SimultaneousSaveException.prototype.constructor = SimultaneousSaveException;

        /**
         * Overridden toString method to represent this exception more meaningfully than '[Object object]'.
         *
         */
        SimultaneousSaveException.prototype.toString = function () {
            return this.message;
        }

        Polymer.TgBehaviors = Polymer.TgBehaviors || {};
    	Polymer.TgBehaviors.TgEntityMasterBehaviorImpl = {
    			
        	properties: {
            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            	////////////////////////////////////////// EXTERNAL PROPERTIES //////////////////////////////////////////
            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            	// These mandatory properties must be specified in attributes, when constructing descendant elements.  //
            	// No default values are allowed in this case.														   //
            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            	
            	/**
            	 * The full java class name of the entity type. The entities of this type will be bound to this entity master.
            	 */
            	entityType: {
            		type: String
            	},

            	/**
            	 * The id of the curently bound entity (or 'new' in case of entity without id, aka 'not yet persisted' one).
            	 *
            	 * Sets initially during tg-entity-master generation phase and then updates accordingly.
            	 */
            	entityId: {
            		type: String
            	},
            	
                /**
                 * Custom callback that will be invoked after successfull retrieval.
                 *
                 * arguments: entity, bindingEntity, customObject
                 */
                postSaved: {
                	type: Function                	
                }, 
                
                /**
                 * Universal identifier of parent centre instance (used for pub / sub communication).
                 *
                 * Should be given from the outside of the element.
                 */
                centreUuid: {
                	type: String
                },
                
				////////////////////////////////////// SUBSECTION: NOT MANDATORY PROPERTIES //////////////////////////////////////
                
                /**
                 * The context in which save() action should be performed (it is not defined in case when context is not needed).
                 */
            	savingContext: {
            		type: Object
            	},
            	
				/**
				 * The module where the master is located.
				 *
				 * This parameter is populated during dynamic loading of the master.
				 */
                moduleId: {
            		type: String
            	},
            	
             	/////////////////////////////////////////////////////////////////////////////////////////////////////////
             	//////////////////////////////// INNER PROPERTIES, THAT GOVERN CHILDREN /////////////////////////////////
             	/////////////////////////////////////////////////////////////////////////////////////////////////////////
             	// These properties derive from other properties and are considered as 'private' -- need to have '_'   //
             	//   prefix. 																				           //
             	// Also, these properties are designed to be bound to children element properties -- it is necessary to//
             	//   populate their default values in ready callback (to have these values populated in children)!     //
             	/////////////////////////////////////////////////////////////////////////////////////////////////////////                
                
                /**
                 * Default implementation for postSaved callback.
                 */
                _postSavedDefault: {
                	type: Function
                },
                
                /**
                 * Default implementation for unsuccessful postSaved callback.
                 */
                _postSavedDefaultError: {
                	type: Function
                },
                
                /**
                 * The map of actions by their name ids.
                 *
                 * Every action consists of three callbacks ('preAction', 'postActionSuccess', 'postActionError') and
                 * 'shortDesc', 'longDesc', 'icon' + 'enabledStates'.
                 *
                 * 'EnabledStates' are the states in which the action is enabled.
                 */
                _actions: {
                	type: Object                	
                },
                
                /**
                 * Changes the state to 'EDIT'.
                 */
                edit: {
                	type: Function
                },

                /**
                 * Changes the state to 'VIEW'.
                 */
                view: {
                	type: Function
                },

                /**
                 * Starts the process of entity saving (based on _currBindingEntity).
                 */
                save: {
                	type: Function
                },
                
                /**
                 * The callback to strictly use for testing -- invokes after _ajaxSaver() has finished loading ('loading' property becomes 'false').
                 */
                _postSaverLoadingFinished: {
                	type: Function
                },
                
                /**
                 * Indicates whether the saver is loading.
                 */
                _saverLoading: {
                	type: Boolean,
                	observer: '_saverLoadingChanged'
                },
                
                /**
                 * The context holder creator (SavingInfoHolder) which is used for embedded views.
                 */
                _createContextHolderForEmbeddedViews: {
                    type: Function
                }
        	},

            /**
             * Initialisation block. It has all children web components already initialised.
             */
            ready: function () {
                var self = this;
                
                self._processSaverResponse = function (e) {
                	self._processResponse(e, "save", function (potentiallySavedEntity) {
                		return self._postSavedDefault(potentiallySavedEntity);
                	});
                };
                
                self._processSaverError = function (e) {
                	self._processError(e, "save", function (errorResult) {
                	    return self._postSavedDefaultError(errorResult);
                    });
                };

				self._createActions();
				
				// calbacks, that will potentially be augmented by tg-action child elements: 
                self._postSavedDefault = (function (potentiallySavedEntity) {
				    var msg = this._toastMsg("Saving", potentiallySavedEntity);
				    this._openToast(potentiallySavedEntity, msg, !potentiallySavedEntity.isValid() || potentiallySavedEntity.isValidWithWarning(), msg, false);
				
				    var newBindingEntity = this._postEntityReceived(potentiallySavedEntity, false);
				
				    // custom external action
				    this.postSaved(potentiallySavedEntity, newBindingEntity);
				    
				    // Context creator should assigned only after successful master entity saving.
				    // In case of successful assignment it gets promoted to embedded views by means of binding.
				    if (potentiallySavedEntity.isValid()) {
					    this._createContextHolderForEmbeddedViews = (function () {
			                var holder = this._extractModifiedPropertiesHolder(this._currBindingEntity, this._originalBindingEntity);
			                return this._reflector().createSavingInfoHolder(this._reset(holder), this.savingContext);
		                }).bind(this);
				    }
				    
				    return potentiallySavedEntity.isValid();
				}).bind(self);
				
                self._postSavedDefaultError = (function (errorResult) {
                	// This function will be invoked after server-side error appear.
                	// 'tg-action' will augment this function with its own '_afterExecution' logic (spinner stopping etc.).                	
                	console.warn("SERVER ERROR: ", errorResult);
                }).bind(self);
                
                self.edit = (function () {
                    if (this.currentState === 'EDIT') {
                        console.warn("The master is already in EDIT state. state == ", this.currentState);
                    } else {
                        this.currentState = 'EDIT';
                    }
                }).bind(self);
                
                self.view = (function () {
                    if (this.currentState === 'VIEW') {
                        console.warn("The master is already in VIEW state. state == ", this.currentState);
                    } else {
                        this.currentState = 'VIEW';
                    }
                }).bind(self);
                
                self.save = (function () {
                    if (this._savingInProgress()) {
                        var SimultaneousSaveException = this._getSimultaneousSaveExceptionType();
                        throw new SimultaneousSaveException();
                    }

                    this._startRefreshCycleModeForEditors();

                    var holder = this._extractModifiedPropertiesHolder(this._currBindingEntity, this._originalBindingEntity);
                    // cancel previous validation before starting saving process -- it includes validation process internally!
                    this._validator().abortValidationIfAny();

                    // IMPORTANT: at this stage no client side check is needed for hasModified(holder).
                    //            This check will be done on server -- and appropriate _postSavedDefault callback will be triggered.
                    return this._saveModifiedProperties(this._reset(holder));
                    // if (this._hasModified(holder)) {
                    //     this._saveModifiedProperties(this._reset(holder));
                    // } else {
                    //     this._validator().validate(this._reset(holder));
                    // }
                    
                }).bind(self);
                
                self._postSaverLoadingFinished = (function () {
                	console.log("_postSaverLoadingFinished");
                }).bind(self);
            },
            
            attached: function() {
                var self = this;
                self.saveListener = postal.subscribe({
                    channel: "master_"  + self.uuid,
                    topic: "save.finish",
                    callback: function(data, envelope) {
                        postal.publish({
                            channel: "centre_" + self.centreUuid,
                            topic: "detail.saved",
                            data: data
                        });
                        console.log("--------------saved finished for: " + self.uuid + "------------");
                    }
                });
            },
            
            detached: function() {
                console.log("-------master detached: " + this.uuid + "------------");
                this.saveListener.unsubscribe();
            },
            
            /**
             * Creates default master actions.
             */
            _createActions: function () {
            	var self = this;
                self._actions = {};

                self._actions['REFRESH'] = {
                    shortDesc: 'REFRESH',
                    longDesc: 'REFRESH ACTION...',
                    enabledStates: ['EDIT', 'VIEW'],
                    action: function () {
                        return self.retrieve();
                    }
                };
                self._notifyActionPathsFor('REFRESH', true);
                self._actions['VALIDATE'] = {
                    shortDesc: 'VALIDATE',
                    longDesc: 'VALIDATE ACTION...',
                    enabledStates: ['EDIT'],
                    action: function () {
                        self.validate();
                    }
                };
                self._notifyActionPathsFor('VALIDATE', true);
                self._actions['SAVE'] = {
                    shortDesc: 'SAVE',
                    longDesc: 'SAVE ACTION...',
                    enabledStates: ['EDIT'],
                    action: function () {
                        return self.save();
                    }
                };                
                self._notifyActionPathsFor('SAVE', true);

                self._actions['EDIT'] = {
                    shortDesc: 'EDIT',
                    longDesc: 'EDIT ACTION...',
                    enabledStates: ['VIEW'],
                    action: function () {
                        self.edit();
                        this.postAction(null);
                    },
                    postAction: function (e) {}
                };
                self._notifyActionPathsFor('EDIT', false);
                
                /* self.set('_actions.VIEW', {});
                self.set('_actions.VIEW.shortDesc', 'VIEW');
                self.set('_actions.VIEW.longDesc', 'VIEW ACTION...');
                self.set('_actions.VIEW.enabledStates', ['EDIT']);
                self.set('_actions.VIEW.action', function () {
                    self.view();
                    this.postAction(null);
                });
                self.set('_actions.VIEW.postAction', function (e) {                	
                }); */
                
                self._actions['VIEW'] = {
                    shortDesc: 'VIEW',
                    longDesc: 'VIEW ACTION...',
                    enabledStates: ['EDIT'],
                    action: function () {
                        self.view();
                        this.postAction(null);
                    },
                    postAction: function (e) {}
                };
                self._notifyActionPathsFor('VIEW', false);
            },
            
            /**
             * Notifies all the paths of newly promoted action with concrete name (this is necessary for binding to child elements).
             */
            _notifyActionPathsFor: function (actionName, withoutPostAction) {
            	var path0 = '_actions.' + actionName;
            	var action0 = this._actions[actionName];
            	
            	this.notifyPath(path0, action0); // notify root
            	this.notifyPath(path0 + ".shortDesc", action0.shortDesc);
            	this.notifyPath(path0 + ".longDesc", action0.longDesc);
            	this.notifyPath(path0 + ".enabledStates", action0.enabledStates);
            	this.notifyPath(path0 + ".action", action0.action);
            	if (!withoutPostAction) {
	            	this.notifyPath(path0 + ".postAction", action0.postAction);
            	}
            	// TODO postActionError?
            },

            /**
             * The tg-entity-validator component for entity validation.
             */
            _validator: function () {
            	throw "_validator: not implemented";
            },
            
            /**
             * The ajax-saver component.
             */
            _ajaxSaver: function () {
            	throw "_ajaxSaver: not implemented";
            },

            /** 
             * The function for binding property title -- entity.type().prop(property).title(). The argument 'entity' will be changed in future. Polymer will listen to that change.
             * The function for binding property desc -- entity.type().prop(property).desc(). The argument 'entity' will be changed in future. Polymer will listen to that change.
             */

             //////////////////////////////////////// VALIDATION ////////////////////////////////////////
             /**
              * Overridden to reuse this.savingContext. It is not empty for tg-ui-action's functional entities, which is assigned in its method _onExecuted.
              */
             _validateForDescendants: function (preparedModifHolder) {
                 this._validator().validate(preparedModifHolder, this.savingContext);
             },

            //////////////////////////////////////// SAVING ////////////////////////////////////////
            _savingInProgress: function () {
                return this._ajaxSaver().loading;
            },
            
            /**
             * Starts the process of entity saving.
             *
             * @param modifiedPropertiesHolder -- the entity with modified properties
             */
            _saveModifiedProperties: function (modifiedPropertiesHolder) {
                this._ajaxSaver().body = JSON.stringify(this._serialiser().serialise(this._reflector().createSavingInfoHolder(modifiedPropertiesHolder, this.savingContext)));
                return this._ajaxSaver().generateRequest().completes;
            },

            /**
             * Returns 'true' if the entity has been modified from original, 'false' otherwise.
             *
             * NOTE: it is designed to be used once (after that hasModified() will not be working for the same instance of modPropsHolder).
             *
             * @param modifiedPropertiesHolder -- the entity with modified properties
             */
            _hasModified: function (modifiedPropertiesHolder) {
                return modifiedPropertiesHolder["@modified"];
            },

            //////////////////////////////////////// BINDING & UTILS ////////////////////////////////////////
            _getSimultaneousSaveExceptionType: function () {
                return SimultaneousSaveException;
            },
            
            _saverLoadingChanged: function (newValue, oldValue) {
            	console.log("_saverLoadingChanged:", newValue, oldValue);
            	if (oldValue === true && newValue === false) {
            		this._postSaverLoadingFinished();
            	}
            }
        };
    	
		Polymer.TgBehaviors.TgEntityMasterBehavior = [
			Polymer.TgBehaviors.TgEntityBinderBehavior,
			Polymer.TgBehaviors.TgEntityMasterBehaviorImpl
		];
		
    })();
</script>