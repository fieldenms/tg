<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/resources/polymer/paper-input/paper-input-container.html">
<link rel="import" href="/resources/polymer/paper-input/paper-input-error.html">
<link rel="import" href="/resources/polymer/paper-input/paper-input-char-counter.html">
<link rel="import" href="/resources/polymer/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/resources/polymer/iron-input/iron-input.html">
<link rel="import" href="/resources/polymer/iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import" href="/resources/master/actions/tg-property-action.html">

<link rel="import" href="/resources/polymer/iron-flex-layout/classes/iron-flex-layout.html">

<!-- link rel="import" href="/resources/polymer/core-tooltip/core-tooltip.html" -->
<link rel="import" href="/tg-reflector">

 <dom-module id="tg-editor">
    <style>
        /*Styles for tooltip*/
        /*:host::shadow * /deep/ core-tooltip::shadow #tooltip {
            white-space: normal;
        }
        :host::shadow * /deep/ core-tooltip .span-tooltip {
            line-height: 15px;
        }
        :host::shadow core-tooltip.delayed:hover::shadow .core-tooltip,
        :host::shadow core-tooltip.delayed:focus::shadow .core-tooltip {
            opacity: 1;
            -webkit-transition-delay: 1s;
            transition-delay: 1s;
            transform: translate3d(0px, 0px, 0px);
        }*/
        #input.upper-case {
            text-transform: uppercase;
        }
        
        /*  */
        .main-container {
            @apply(--layout-horizontal);
            @apply(--layout-center);
        }
        #input-container {
            @apply(--layout-flex);
        }
        /* Styles for boolean property editors. */
        paper-checkbox {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -o-user-select: none;
            font-family: 'Roboto', 'Noto', sans-serif;
            --paper-checkbox-checked-color: #0288D1;
            --paper-checkbox-checked-ink-color: #0288D1;
            height: 24px;
        }
        /* Styles for integer and decimal property editors. */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        paper-checkbox::shadow #checkboxContainer {
            flex-shrink: 0;
        }
        paper-checkbox::shadow #checkboxLabel {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        paper-input-container {
            --paper-input-container-label: {
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }
            ;
        }
        paper-input-error {
            width: 100%;
        }
        
        /* style requiredness */
        paper-input-container.required {
            --paper-input-container-color: #03A9F4;
            --paper-input-container-focus-color: #03A9F4;
        }
        
        paper-input-container.decorator-disabled.required::shadow :not(.is-invalid) .unfocused-line {
        	border-bottom: 1px dashed;
      		background: transparent;
      		opacity: 0.6;
        	border-color: #03A9F4;
        }
        
        /* style warning */
        paper-input-container.warning {
            --paper-input-container-invalid-color: #FFA000;
        }
        
        paper-input-container.decorator-disabled.warning::shadow .is-invalid .unfocused-line {
        	border-bottom: 1px dashed;
      		background: transparent;
      		opacity: 0.6;
        	border-color: #FFA000;
        }
        
        paper-input-container.decorator-disabled.warning::shadow .is-invalid .focused-line {
      		background: transparent !important;
        	border-color: transparent !important;
        }
        
        /* style error */
        paper-input-container.decorator-disabled:not(.required):not(.warning)::shadow .is-invalid .unfocused-line {
        	border-bottom: 1px dashed;
      		background: transparent;
      		opacity: 0.6;
        	border-color: var(--google-red-500);
        }
        
        paper-input-container.decorator-disabled:not(.required):not(.warning)::shadow .is-invalid .focused-line {
      		background: transparent !important;
        	border-color: transparent !important;
        }
        
        /* style not required, not warning and not error -- regular one */
        paper-input-container.decorator-disabled:not(.required):not(.warning)::shadow :not(.is-invalid) .unfocused-line {
        	border-bottom: 1px dashed;
      		background: transparent;
      		opacity: 0.6;
        	border-color: var(--secondary-text-color);
        }
        
        /* The next style chunk is applied on all 'add-on content', for e.g. char-counter, error message etc. */
        paper-input-container.decorator-disabled::shadow .add-on-content ::content {
      		opacity: 0.6;
        }
    </style>

    <template>
        <paper-input-container id="decorator" attr-for-value="editing-value" always-float-label>
            <!-- flex auto  for textarea! -->
            <label style$="[[_calcLabelStyle(_editorKind, _disabled)]]" disabled$="[[_disabled]]">[[propTitle]]</label>
            <div class="main-container">
                <div id="input-container" style$="[[_calcDecoratorPartStyle(_disabled)]]">
                    <!-- allowed-pattern="[0-9]" on-input="inputEventHandler" on-blur="focusLostEventHandler" on-focus="focusGotEventHandler" -->

                    <!-- <template is="dom-if" if="[[_isInteger(_editorKind)]]"> -->
                    <input id="input" is="iron-input" hidden$="[[!_isInteger(_editorKind)]]" type="number" step="1" prevent-invalid-input bind-value="{{_editingValue}}" on-change="_onChange" on-input="_onInput" on-keydown="_onKeydown" disabled$="[[_disabled]]">
                    <!-- </template> -->

                    <input id="input" is="iron-input" hidden$="[[!_isDecimal(_editorKind)]]" type="number" step="any" prevent-invalid-input bind-value="{{_editingValue}}" on-change="_onChange" on-input="_onInput" on-keydown="_onKeydown" disabled$="[[_disabled}}">

                    <input id="input" is="iron-input" hidden$="[[!_isSinglelineTextOrDate(_editorKind)]]" bind-value="{{_editingValue}}" on-change="_onChange" on-input="_onInput" on-keydown="_onKeydown" disabled$="[[_disabled]]">

                    <iron-autogrow-textarea hidden$="[[!_isMultilineText(_editorKind)]]" max-rows="5" bind-value="{{_editingValue}}" max-length="[[_maxLength]]" on-change="_onChange" on-input="_onInput" on-keydown="_onKeydown" disabled$="[[_disabled]]">
                        <!--  flex -->
                        <textarea id="input" disabled$="[[_disabled]]"></textarea>
                    </iron-autogrow-textarea>

                    <paper-checkbox id="input" hidden$="[[!_isBooleanEditor(_editorKind)]]" checked="[[_isBooleanChecked(_editingValue)]]" disabled$="[[_disabled]]" on-change="_onChange" class="layout horizontal center">[[propTitle]]</paper-checkbox>

                    <input id="input" is="iron-input" hidden$="[[!_isAutocompleter(_editorKind)]]" type="text" on-blur="_autocompleterBlurEventHandler" bind-value="{{_editingValue}}" on-change="_onChange" on-input="_onInput" on-keydown="_onKeydown" disabled$="[[_disabled]]" />
                </div>
                <!-- CONTENT HERE: -->
                <content select=".custom-icon-buttons"></content>
                
                <div id="icon" hidden$="[[_actionDoesNotExist(action)]]">
        			<tg-property-action entity-type="[[action.entityType]]" pre-action="[[action.preAction]]" post-action="[[action.postAction]]" post-action-error="[[action.postActionError]]" enabled-states="[[action.enabledStates]]" long-desc="[[action.longDesc]]" short-desc="[[action.shortDesc]]" icon="[[action.icon]]" current-state="[[currentState]]"></tg-property-action>
        		</div>
            </div>

            <paper-input-error hidden$="[[!_error]]" disabled$="[[_disabled]]">[[_error]]</paper-input-error>

            <paper-input-char-counter id="inputCounter" class="footer" hidden$="[[!_isMultilineText(_editorKind)]]" disabled$="[[_disabled]]"></paper-input-char-counter>
        </paper-input-container>
        
        <tg-reflector id="reflector"></tg-reflector>

        <template is="dom-if" if="[[debug]]">
            <p>_editingValue: <i>[[_editingValue]]</i>
            </p>
            <p>_commValue: <i>[[_commValue]]</i>
            </p>
            <p>_acceptedValue: <i>[[_acceptedValue]]</i>
            </p>
        </template>
    </template>
</dom-module>

<script>
    Polymer({
        is: 'tg-editor',

        properties: {
            /////////////////////////////////////////////////////////////////////////////////////////////////////////
            ////////////////////////////////////////// EXTERNAL PROPERTIES //////////////////////////////////////////
            /////////////////////////////////////////////////////////////////////////////////////////////////////////
            // These mandatory properties must be specified in attributes, when constructing <tg-*-editor>s.       //
            // No default values are allowed in this case.														   //
            /////////////////////////////////////////////////////////////////////////////////////////////////////////
            propTitle: String,
            _disabled: {
            	type: Boolean,
            	observer: '_disabledChanged'
            },
            _editingValue: {
                type: String,
                notify: true
            },
            action: Object,
            _error: String,
            _commValue: String,
            _acceptedValue: String,
            debug: Boolean,
            _editorKind: String,
            _onChange: Function,
            _onKeydown: Function,
            _onInput: Function,
            _maxLength: Number,
            _autocompleterBlurEventHandler: Function,
            currentState: String
        },

        _isDecimal: function (editorKind) {
            return 'DECIMAL' === editorKind;
        },

        _isInteger: function (editorKind) {
            return 'INTEGER' === editorKind;
        },

        _isSinglelineTextOrDate: function (editorKind) {
            return 'SINGLELINE_TEXT' === editorKind || 'DATE' === editorKind;
        },

        _isMultilineText: function (editorKind) {
            return 'MULTILINE_TEXT' === editorKind;
        },

        _isBooleanEditor: function (editorKind) {
            return "BOOLEAN" === editorKind;
        },

        _isAutocompleter: function (editorKind) {
            return "AUTOCOMPLETER" === editorKind;
        },

        /**
         * The function for binding 'hidden' attribute of <div>, which contain icon button for action.
         *
         * If action does not exist -- 'action' is 'null', otherwise -- 'action' contains some object.
         */
        _actionDoesNotExist: function (action) {
            return action === null;
        },

        /**
         * Calculates the style for container's label.
         */
        _calcLabelStyle: function (editorKind, _disabled) {
            var style = "";
            if ("BOOLEAN" === editorKind) {
                style += "visibility: hidden;"
            }
            if (_disabled === true) {
                style += "opacity: 0.6;"
            }
            return style;
        },
        
        /**
         * Calculates the style for decorator inner parts, based on '_disabled' property.
         */
        _calcDecoratorPartStyle: function (_disabled) {
            var style = "";
            if (_disabled === true) {
                style += "opacity: 0.6;"
            }
            return style;
        },
        
        /**
         * Returns value that indicates whether boolean editor is checked or not.
         */
        _isBooleanChecked: function (editingValue) {
            return editingValue === 'true';
        },
        
        /**
         * The observer to the '_disabled' property, which maintains appropriately the class list of the decorator (regarding the class 'decorator-disabled').
         */
        _disabledChanged: function (newValue, oldValue) {
        	if (newValue === true) {
            	this.$.decorator.classList.add("decorator-disabled");
        	} else {
        		this.$.decorator.classList.remove("decorator-disabled");
        	}
            this.updateStyles();
        }
    });
</script>