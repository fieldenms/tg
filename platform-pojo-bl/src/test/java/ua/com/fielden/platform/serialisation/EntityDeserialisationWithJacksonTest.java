package ua.com.fielden.platform.serialisation;

import static java.nio.charset.StandardCharsets.UTF_8;
import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertTrue;
import static ua.com.fielden.platform.serialisation.api.impl.Serialiser.createSerialiserWithJackson;
import static ua.com.fielden.platform.web.test.config.ApplicationDomain.entityTypesSet;

import java.io.ByteArrayInputStream;
import java.util.Date;

import org.junit.Test;

import com.google.inject.Injector;

import ua.com.fielden.platform.entity.factory.EntityFactory;
import ua.com.fielden.platform.entity.functional.centre.CentreContextHolder;
import ua.com.fielden.platform.entity.functional.centre.SavingInfoHolder;
import ua.com.fielden.platform.ioc.ApplicationInjectorFactory;
import ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties;
import ua.com.fielden.platform.serialisation.api.ISerialiser;
import ua.com.fielden.platform.serialisation.api.impl.IdOnlyProxiedEntityTypeCacheForTests;
import ua.com.fielden.platform.serialisation.api.impl.ProvidedSerialisationClassProvider;
import ua.com.fielden.platform.serialisation.api.impl.SerialisationTypeEncoder;
import ua.com.fielden.platform.serialisation.jackson.entities.FactoryForTestingEntities;
import ua.com.fielden.platform.test.CommonEntityTestIocModuleWithPropertyFactory;

/**
 * Unit tests to ensure JSON-based entity deserialisation using JACKSON engine.
 *
 * @author TG Team
 *
 */
public class EntityDeserialisationWithJacksonTest {
    private static final Injector injector = new ApplicationInjectorFactory()
        .add(new CommonEntityTestIocModuleWithPropertyFactory())
        .getInjector();
    private static final ISerialiser jacksonDeserialiser = createSerialiserWithJackson(
        new FactoryForTestingEntities(injector.getInstance(EntityFactory.class), new Date()).getFactory(),
        new ProvidedSerialisationClassProvider(entityTypesSet().toArray(new Class<?>[0])),
        new SerialisationTypeEncoder(),
        new IdOnlyProxiedEntityTypeCacheForTests()
    );

    @Test
    public void JSON_entity_with_properties_order_not_matching_CachedProperty_list_order_in_EntityJsonDeserialiser_should_still_be_restored() {
        // we use JSON context for title action on "producerInitProp" on "+" top action master on standard TgPersistentEntityWithProperties centre
        // see more details in https://github.com/fieldenms/tg/issues/2032
        final String json = "{\"@id\":\"ua.com.fielden.platform.entity.functional.centre.CentreContextHolder#1\",\"id\":null,\"version\":0,\"customObject\":{\"@@masterEntityType\":\"ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties\"},\"key\":\"centreContextHolder_key\",\"desc\":\"centreContextHolder description\",\"masterEntity\":{\"@id\":\"ua.com.fielden.platform.entity.functional.centre.SavingInfoHolder#1\",\"id\":null,\"version\":0,\"key\":\"NO_KEY\",\"desc\":\"savingInfoHolder description\",\"modifHolder\":{\"id\":null,\"version\":0,\"@@touchedProps\":[],\"entityProp\":{\"origVal\":null},\"key\":{\"origVal\":\"dummy\"},\"bigDecimalProp\":{\"origVal\":null},\"stringProp\":{\"origVal\":null},\"dateProp\":{\"origVal\":null},\"booleanProp\":{\"origVal\":false},\"compositeProp\":{\"origVal\":null},\"requiredValidatedProp\":{\"origVal\":null},\"status\":{\"origVal\":null},\"colourProp\":{\"origVal\":null},\"hyperlinkProp\":{\"origVal\":null},\"integerProp\":{\"origVal\":null},\"producerInitProp\":{\"origVal\":\"DEFAULT_KEY\",\"origValId\":13},\"moneyProp\":{\"origVal\":null},\"nonConflictingProp\":{\"origVal\":null},\"conflictingProp\":{\"origVal\":null},\"domainInitProp\":{\"origVal\":\"ok\"},\"completed\":{\"origVal\":false}},\"originallyProducedEntity\":{\"@id\":\"ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties#1\",\"@_i\":null,\"id\":null,\"version\":0,\"key\":\"dummy\",\"@key\":{\"_required\":true,\"_assigned\":true},\"integerProp\":null,\"@integerProp\":{\"_max\":9999,\"_assigned\":true},\"entityProp\":null,\"@entityProp\":{\"_assigned\":true},\"bigDecimalProp\":null,\"@bigDecimalProp\":{\"_assigned\":true},\"stringProp\":null,\"@stringProp\":{\"_assigned\":true},\"booleanProp\":false,\"@booleanProp\":{\"_assigned\":true},\"dateProp\":null,\"@dateProp\":{\"_assigned\":true},\"producerInitProp\":{\"@id\":\"ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties#2\",\"@_i\":null,\"id\":13,\"version\":1,\"key\":\"DEFAULT_KEY\",\"@key\":{\"_required\":true,\"_assigned\":true},\"critOnlyEntityProp\":null,\"@critOnlyEntityProp\":{\"_assigned\":false},\"critOnlyDateProp\":null,\"@critOnlyDateProp\":{\"_assigned\":false},\"userParam\":null,\"@userParam\":{\"_assigned\":false},\"critOnlyIntegerProp\":null,\"@critOnlyIntegerProp\":{\"_assigned\":false},\"critOnlyBigDecimalProp\":null,\"@critOnlyBigDecimalProp\":{\"_assigned\":false},\"critOnlyBooleanProp\":false,\"@critOnlyBooleanProp\":{\"_cfo\":true,\"_originalVal\":null,\"_assigned\":false},\"critOnlyStringProp\":null,\"@critOnlyStringProp\":{\"_assigned\":false},\"cosStaticallyRequired\":null,\"@cosStaticallyRequired\":{\"_required\":true,\"_assigned\":false},\"cosStaticallyReadonly\":null,\"@cosStaticallyReadonly\":{\"_editable\":false,\"_assigned\":false},\"cosEmptyValueProhibited\":null,\"@cosEmptyValueProhibited\":{\"_assigned\":false},\"cosConcreteValueProhibited\":null,\"@cosConcreteValueProhibited\":{\"_assigned\":false},\"cosStaticallyRequiredWithDefaultValue\":null,\"@cosStaticallyRequiredWithDefaultValue\":{\"_required\":true,\"_assigned\":false},\"cosStaticallyReadonlyWithDefaultValue\":null,\"@cosStaticallyReadonlyWithDefaultValue\":{\"_editable\":false,\"_assigned\":false},\"cosWithValidator\":null,\"@cosWithValidator\":{\"_assigned\":false},\"cosWithDependency\":null,\"@cosWithDependency\":{\"_assigned\":false},\"cosWithWarner\":null,\"@cosWithWarner\":{\"_assigned\":false},\"cosStaticallyRequiredWithNonEmptyDefaultValue\":null,\"@cosStaticallyRequiredWithNonEmptyDefaultValue\":{\"_required\":true,\"_assigned\":false},\"cosWithACE1\":null,\"@cosWithACE1\":{\"_assigned\":false},\"cosWithACE1Child1\":null,\"@cosWithACE1Child1\":{\"_assigned\":false},\"cosWithACE1Child2\":null,\"@cosWithACE1Child2\":{\"_assigned\":false},\"cosWithACE1WithDefaultValue\":null,\"@cosWithACE1WithDefaultValue\":{\"_assigned\":false},\"cosWithACE1WithDefaultValueChild1\":null,\"@cosWithACE1WithDefaultValueChild1\":{\"_assigned\":false},\"cosWithACE1WithDefaultValueChild2\":null,\"@cosWithACE1WithDefaultValueChild2\":{\"_assigned\":false},\"cosWithACE2\":null,\"@cosWithACE2\":{\"_assigned\":false},\"cosWithACE2Child1\":null,\"@cosWithACE2Child1\":{\"_assigned\":false},\"cosWithACE2Child2\":null,\"@cosWithACE2Child2\":{\"_assigned\":false},\"cosWithACE2WithDefaultValue\":null,\"@cosWithACE2WithDefaultValue\":{\"_assigned\":false},\"cosWithACE2WithDefaultValueChild1\":null,\"@cosWithACE2WithDefaultValueChild1\":{\"_assigned\":false},\"cosWithACE2WithDefaultValueChild2\":null,\"@cosWithACE2WithDefaultValueChild2\":{\"_assigned\":false},\"completed\":false,\"@completed\":{\"_assigned\":true},\"desc\":\"Default entity description\",\"@desc\":{\"_assigned\":true}},\"@producerInitProp\":{\"_assigned\":true},\"domainInitProp\":\"ok\",\"@domainInitProp\":{\"_assigned\":true},\"nonConflictingProp\":null,\"@nonConflictingProp\":{\"_assigned\":true},\"conflictingProp\":null,\"@conflictingProp\":{\"_assigned\":true},\"compositeProp\":null,\"@compositeProp\":{\"_assigned\":true},\"moneyProp\":null,\"@moneyProp\":{\"_assigned\":true},\"critOnlyEntityProp\":null,\"@critOnlyEntityProp\":{\"_assigned\":true},\"requiredValidatedProp\":null,\"@requiredValidatedProp\":{\"_required\":true,\"_assigned\":true},\"numberOfAttachments\":0,\"@numberOfAttachments\":{\"_editable\":false,\"_assigned\":true},\"critOnlyDateProp\":null,\"@critOnlyDateProp\":{\"_assigned\":true},\"userParam\":null,\"@userParam\":{\"_assigned\":true},\"critOnlyIntegerProp\":null,\"@critOnlyIntegerProp\":{\"_assigned\":true},\"critOnlyBigDecimalProp\":null,\"@critOnlyBigDecimalProp\":{\"_assigned\":true},\"critOnlyBooleanProp\":false,\"@critOnlyBooleanProp\":{\"_assigned\":true},\"critOnlyStringProp\":null,\"@critOnlyStringProp\":{\"_assigned\":true},\"status\":null,\"@status\":{\"_assigned\":true},\"colourProp\":null,\"@colourProp\":{\"_assigned\":true},\"hyperlinkProp\":null,\"@hyperlinkProp\":{\"_assigned\":true},\"proxyProp\":null,\"@proxyProp\":{\"_assigned\":true},\"idOnlyProxyProp\":\"_______id_only_proxy_______7\",\"@idOnlyProxyProp\":{\"_cfo\":false,\"_originalVal\":\"_______id_only_proxy_______7\",\"_prevValue\":\"_______id_only_proxy_______7\",\"_assigned\":true},\"cosStaticallyRequired\":null,\"@cosStaticallyRequired\":{\"_required\":true,\"_assigned\":true},\"cosStaticallyReadonly\":null,\"@cosStaticallyReadonly\":{\"_editable\":false,\"_assigned\":true},\"cosEmptyValueProhibited\":null,\"@cosEmptyValueProhibited\":{\"_assigned\":true},\"cosConcreteValueProhibited\":null,\"@cosConcreteValueProhibited\":{\"_assigned\":true},\"cosStaticallyRequiredWithDefaultValue\":null,\"@cosStaticallyRequiredWithDefaultValue\":{\"_required\":true,\"_assigned\":true},\"cosStaticallyReadonlyWithDefaultValue\":null,\"@cosStaticallyReadonlyWithDefaultValue\":{\"_editable\":false,\"_assigned\":true},\"cosWithValidator\":null,\"@cosWithValidator\":{\"_assigned\":true},\"cosWithDependency\":null,\"@cosWithDependency\":{\"_assigned\":true},\"cosWithWarner\":null,\"@cosWithWarner\":{\"_assigned\":true},\"cosStaticallyRequiredWithNonEmptyDefaultValue\":null,\"@cosStaticallyRequiredWithNonEmptyDefaultValue\":{\"_required\":true,\"_assigned\":true},\"cosWithACE1\":null,\"@cosWithACE1\":{\"_assigned\":true},\"cosWithACE1Child1\":null,\"@cosWithACE1Child1\":{\"_assigned\":true},\"cosWithACE1Child2\":null,\"@cosWithACE1Child2\":{\"_assigned\":true},\"cosWithACE1WithDefaultValue\":null,\"@cosWithACE1WithDefaultValue\":{\"_assigned\":true},\"cosWithACE1WithDefaultValueChild1\":null,\"@cosWithACE1WithDefaultValueChild1\":{\"_assigned\":true},\"cosWithACE1WithDefaultValueChild2\":null,\"@cosWithACE1WithDefaultValueChild2\":{\"_assigned\":true},\"cosWithACE2\":null,\"@cosWithACE2\":{\"_assigned\":true},\"cosWithACE2Child1\":null,\"@cosWithACE2Child1\":{\"_assigned\":true},\"cosWithACE2Child2\":null,\"@cosWithACE2Child2\":{\"_assigned\":true},\"cosWithACE2WithDefaultValue\":null,\"@cosWithACE2WithDefaultValue\":{\"_assigned\":true},\"cosWithACE2WithDefaultValueChild1\":null,\"@cosWithACE2WithDefaultValueChild1\":{\"_assigned\":true},\"cosWithACE2WithDefaultValueChild2\":null,\"@cosWithACE2WithDefaultValueChild2\":{\"_assigned\":true},\"propertyDescriptorProp\":null,\"@propertyDescriptorProp\":{\"_assigned\":true},\"completed\":false,\"@completed\":{\"_assigned\":true},\"desc\":null,\"@desc\":{\"_assigned\":true},\"@entityProp.entityProp\":{}},\"centreContextHolder\":{\"@id\":\"ua.com.fielden.platform.entity.functional.centre.CentreContextHolder#2\",\"id\":null,\"version\":0,\"customObject\":{\"@@funcEntityType\":\"ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties\"},\"key\":\"centreContextHolder_key\",\"desc\":\"centreContextHolder description\",\"masterEntity\":{\"@id\":\"ua.com.fielden.platform.entity.functional.centre.SavingInfoHolder#2\",\"id\":null,\"version\":0,\"key\":\"NO_KEY\",\"desc\":\"savingInfoHolder description\",\"modifHolder\":{\"id\":null,\"version\":0,\"@@touchedProps\":[],\"entityType\":{\"origVal\":\"ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties\"},\"importUri\":{\"origVal\":\"/master_ui/ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties\"},\"elementName\":{\"origVal\":\"tg-TgPersistentEntityWithProperties-master\"}},\"originallyProducedEntity\":{\"@id\":\"ua.com.fielden.platform.entity.EntityNewAction#1\",\"@_i\":null,\"id\":null,\"version\":0,\"key\":\"NO_KEY\",\"@key\":{\"_required\":true,\"_assigned\":true},\"entityType\":\"ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties\",\"@entityType\":{\"_assigned\":true},\"importUri\":\"/master_ui/ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties\",\"@importUri\":{\"_assigned\":true},\"elementName\":\"tg-TgPersistentEntityWithProperties-master\",\"@elementName\":{\"_assigned\":true}},\"centreContextHolder\":{\"@id\":\"ua.com.fielden.platform.entity.functional.centre.CentreContextHolder#3\",\"id\":null,\"version\":0,\"customObject\":{\"@@miType\":\"ua.com.fielden.platform.ui.menu.sample.MiEntityCentreNotGenerated\",\"@@saveAsName\":\"\",\"@@actionKind\":\"TOP_LEVEL\",\"@@actionNumber\":0,\"@@resultSetHidden\":false,\"@@funcEntityType\":\"ua.com.fielden.platform.entity.EntityNewAction\"},\"key\":\"centreContextHolder_key\",\"desc\":\"centreContextHolder description\",\"modifHolder\":{\"id\":333,\"version\":1,\"@@touchedProps\":[],\"tgPersistentEntityWithProperties_\":{\"origVal\":[]},\"tgPersistentEntityWithProperties_stringProp\":{\"origVal\":null},\"tgPersistentEntityWithProperties_integerProp_from\":{\"origVal\":null},\"tgPersistentEntityWithProperties_integerProp_to\":{\"origVal\":null},\"tgPersistentEntityWithProperties_entityProp\":{\"origVal\":[]},\"tgPersistentEntityWithProperties_bigDecimalProp_from\":{\"origVal\":null},\"tgPersistentEntityWithProperties_bigDecimalProp_to\":{\"origVal\":null},\"tgPersistentEntityWithProperties_booleanProp_is\":{\"origVal\":true},\"tgPersistentEntityWithProperties_booleanProp_not\":{\"origVal\":true},\"tgPersistentEntityWithProperties_dateProp_from\":{\"origVal\":null},\"tgPersistentEntityWithProperties_dateProp_to\":{\"origVal\":null},\"tgPersistentEntityWithProperties_compositeProp\":{\"origVal\":[]},\"tgPersistentEntityWithProperties_critOnlyDateProp\":{\"origVal\":1000000000},\"tgPersistentEntityWithProperties_critOnlyEntityProp\":{\"origVal\":\"KEY8\",\"origValId\":12},\"tgPersistentEntityWithProperties_userParam\":{\"origVal\":\"SU\",\"origValId\":0},\"tgPersistentEntityWithProperties_critOnlyIntegerProp\":{\"origVal\":1},\"tgPersistentEntityWithProperties_critOnlyBigDecimalProp\":{\"origVal\":3},\"tgPersistentEntityWithProperties_critOnlyBooleanProp\":{\"origVal\":false},\"tgPersistentEntityWithProperties_critOnlyStringProp\":{\"origVal\":\"DE*\"},\"tgPersistentEntityWithProperties_status\":{\"origVal\":[]},\"@@metaValues\":{\"\":{},\"stringProp\":{},\"integerProp\":{},\"entityProp\":{},\"bigDecimalProp\":{},\"booleanProp\":{},\"dateProp\":{},\"compositeProp\":{},\"critOnlyDateProp\":{},\"critOnlyEntityProp\":{},\"userParam\":{},\"critOnlyIntegerProp\":{},\"critOnlyBigDecimalProp\":{},\"critOnlyBooleanProp\":{},\"critOnlyStringProp\":{},\"status\":{\"orNull\":true,\"not\":true}},\"@@wasRun\":\"yes\"},\"selectedEntities\":[]},\"continuations\":[],\"continuationProperties\":[]}},\"continuations\":[],\"continuationProperties\":[]},\"selectedEntities\":[{\"@id_ref\":\"ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties#2\"}]}";
        final ByteArrayInputStream stream = new ByteArrayInputStream(json.getBytes(UTF_8));
        final CentreContextHolder restoredEntity = jacksonDeserialiser.deserialise(stream, CentreContextHolder.class);

        assertNotNull(restoredEntity);

        assertTrue(restoredEntity.getMasterEntity() instanceof SavingInfoHolder);
        final SavingInfoHolder savingInfoHolder = (SavingInfoHolder) restoredEntity.getMasterEntity();
        assertNotNull(savingInfoHolder.getOriginallyProducedEntity());
        final TgPersistentEntityWithProperties producerInitProp = savingInfoHolder.getOriginallyProducedEntity().get("producerInitProp");
        assertNotNull(producerInitProp);

        assertFalse(restoredEntity.getSelectedEntities().isEmpty());
        assertNotNull(restoredEntity.getSelectedEntities().get(0));

        assertTrue(producerInitProp == restoredEntity.getSelectedEntities().get(0));
    }

}